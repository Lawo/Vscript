"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const fs=require("fs-extra"),http_1=require("http");function upload_installer(t,e){return new Promise((r,n)=>{const s=e.connection_pars.ip,a="wss"===e.connection_pars.protocol?"https:":"http:";fs.stat(t,(e,l)=>{if(e);else{const e=l.size;fs.createReadStream(t).pipe(http_1.request({protocol:a,method:"PUT",hostname:s,port:80,headers:{"Content-Type":"application/octet-stream","Content-Length":e},path:"/software_update"},t=>{200===t.statusCode?r():n(t.statusCode)}))}})})}function start_installer_upload(t,e){upload_installer(t.filename,e.con).catch(t=>void 0)}function start_installer(t){t.dispatch_change_request("software_update","install",!0),t.dispatch_change_request("software_update","install","Click")}function install(t,e){return new Promise((r,n)=>{upload_installer(t,e).then(()=>{let t=setTimeout(()=>{e.unregister_handler("reconnect","reconnect-handler"),n()},18e4);e.register_void_handler("reconnect",()=>{clearTimeout(t),e.unregister_handler("reconnect","reconnect-handler"),r()},"reconnect-handler"),start_installer(e)})})}exports.upload_installer=upload_installer,exports.start_installer_upload=start_installer_upload,exports.start_installer=start_installer,exports.install=install;