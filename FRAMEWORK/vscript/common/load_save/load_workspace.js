"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const pervasives_1=require("../pervasives"),multi_connection_1=require("../multi_connection"),api_reflection_1=require("../api/api_reflection");class LoadWorkspace{constructor(e){this.keyword_descriptions={},this.subtree_descriptions={},this.kwl_relocations={},this.state_description=e}fork(){return new LoadWorkspace(this.state_description)}static async create(e){let t=await multi_connection_1.get().get_connection_or_default(e);const s=await api_reflection_1.get_state_description(t.connection_pars.ip);if(null===s)throw`Unable to obtain state description from ${t.connection_pars.ip}`;return new LoadWorkspace(s)}static prefix_set(e){const t=e.split(".");let s=[];for(let e=t.length;e>0;e--)s.push(t.slice(0,e).join("."));return s}translate(e){for(const t of LoadWorkspace.prefix_set(e))if(this.kwl_relocations.hasOwnProperty(t)){const s=e.substring(t.length,e.length);return this.kwl_relocations[t]+s}return e}register_kwl_relocation(e,t){this.kwl_relocations[e]=t}is_table(e){return void 0!==this.get_subtree_description(e).table_size}get_subtree_description(e){const t=pervasives_1.remove_all_indices(e);if(this.subtree_descriptions.hasOwnProperty(t))return this.subtree_descriptions[t];const s=api_reflection_1.get_subtree_description(this.state_description,t);return this.subtree_descriptions[t]=s,s}get_keyword_description(e,t){const s=pervasives_1.remove_all_indices(e);if(this.keyword_descriptions.hasOwnProperty(s)||(this.keyword_descriptions[s]={}),this.keyword_descriptions[s].hasOwnProperty(t))return this.keyword_descriptions[s][t];const i=api_reflection_1.get_keyword_description(this.state_description,s,t);return this.keyword_descriptions[s][t]=i,i}get_nested_relocations(){let e={},t=e;const s=(e,i)=>{const r=pervasives_1.path_hd(e);if(t.hasOwnProperty("nested")||(t.nested={}),t.nested.hasOwnProperty(r)||(t.nested[r]={}),r===e)t.nested[r].new_local_name=pervasives_1.path_hd(i);else{const o=t;t=t.nested[r],s(pervasives_1.path_tl(e),pervasives_1.path_tl(i)),t=o}};for(const e in this.kwl_relocations)s(e,this.kwl_relocations[e]);return e}}exports.LoadWorkspace=LoadWorkspace;